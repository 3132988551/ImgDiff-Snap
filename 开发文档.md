# ImgDiff Snap 开发文档

> 目标：在 1 个工作日内实现一个纯前端（React + Vite + Canvas 2D）图片像素差分小工具，满足本文档的功能与非功能要求；构建产物为可离线托管的纯静态站点。

## 1. 目标与范围
- 拖拽两张相同尺寸图片，进行像素级差分。
- 提供阈值滑杆（0–255，步进 1，默认 32），实时更新两种视图：左右滑块对比与红色差异热力图。
- 显示唯一指标“变化占比”（忽略任一图 α<255 的像素）。
- 一键下载“仅热力图”PNG，尺寸与输入原始尺寸一致，文件名含阈值与时间戳。
- 全程本地运行，无登录、无联网、无遥测；内置 3 组 CC0 示例以便开箱体验。

不在本次范围（后续可扩展）：自动对齐、MSE/PSNR/SSIM、JSON/ZIP 导出、批量/基线/CI、PWA/桌面封装。

## 2. 技术栈与依赖
- 语言/构建：TypeScript 5 + Vite + ESLint + Prettier。
- 运行时：React 18（仅 `react`/`react-dom`）；零其他运行时依赖。
- 渲染：Canvas 2D；≥6MP 时启用 Web Worker（Worker 仅做计算，主线程绘制）。OffscreenCanvas 作为后续可选优化，不在本次实现范围。
- 可选体积优化：可提供替换为 Preact 的配置（`preact/compat` alias），默认不启用。
- 浏览器范围：Chrome / Edge / Firefox / Safari（最近两个稳定版本）。移动端横屏可用但不承诺完整适配。

## 3. 目录结构（建议）
```
./
├─ public/
│  ├─ examples/                # 3 组示例（CC0），每组两个同尺寸图片
│  └─ favicon.svg
├─ src/
│  ├─ App.tsx                  # 根组件（useReducer 管理轻量状态）
│  ├─ components/
│  │  ├─ DropZone.tsx          # 拖拽/选择文件，展示文件名与尺寸
│  │  ├─ ControlBar.tsx        # 阈值滑杆、示例选择、交换左右、下载
│  │  ├─ SplitView.tsx         # 左右滑块对比视图（键盘可访问）
│  │  ├─ HeatmapView.tsx       # 热力图视图（棋盘格背景）
│  │  └─ Stats.tsx             # 变化占比展示
│  ├─ workers/
│  │  └─ diff.worker.ts        # Worker 入口（仅计算，不绘制）
│  ├─ utils/
│  │  ├─ image.ts              # 加载/校验/EXIF 方向/像素提取
│  │  ├─ canvas.ts             # 画布创建、下载、棋盘格、文件名 slug
│  │  └─ math.ts               # 映射表/统计等
│  ├─ styles/
│  │  └─ index.css
│  ├─ main.tsx
│  └─ vite-env.d.ts
├─ index.html
├─ vite.config.ts
├─ tsconfig.json
├─ .eslintrc.cjs
├─ .prettierrc
├─ LICENSE (MIT)
└─ 开发文档.md                 # 本文件（不加入 git）
```

## 4. 关键功能规格
### 4.1 文件与尺寸
- 支持 PNG / JPEG / WebP，本地解码优先：`createImageBitmap(file, { imageOrientation: 'from-image' })`；不支持时回退为 `createImageBitmap(file)`（避免手机照片被旋转，但不中断）。
- 尺寸要求：两张图片宽高必须完全一致；否则阻止并提示（带出两图尺寸，如 `1920×1080 vs 2048×1080`）。
- 资源上限：
  - 单图总像素 ≤ 16MP（例如 4000×4000）；
  - 任一边 ≤ 8192 px（规避 GPU/Canvas 限制）；
  - 超出即报错提示，拒绝处理。

### 4.2 差分算法与阈值
- 差异度量（8-bit）：`d = (|ΔR| + |ΔG| + |ΔB|) / 3`，范围 `[0, 255]`。
- 阈值规则：
  - 若 `d ≤ t`（t 为阈值），该像素在热力图中透明（alpha=0），且不计入变化像素；
  - 若 `d > t`，热力图以纯红色显示，透明度线性映射：`α = round(255 * (d - t) / (255 - t))`（t=255 时 α 始终为 0）。
- 变化占比：
  - 忽略任一张 α<255 的像素（既不着色也不计入分母）；
  - 分母：有效像素数；分子：`d > t` 的像素数；
  - 显示为百分比，两位小数（例如 `12.34%`）。

### 4.3 单次遍历与增量更新
- 首次载入两图后，进行一次像素扫描：
  - 计算 `d` 并写入 `Uint8Array diff[]`；
  - 构建 `Uint8Array validMask[]`（1=有效；0=忽略）；
  - 统计 `validCount`；
- 阈值变更时：不再重算 `d`，仅基于 `diff[]` + `validMask[]` 重映射并统计变化像素数；可使用长度 256 的查表 `alphaLut[d]` 加速。

### 4.4 视图
- 左右滑块对比：
  - 交互：拖动分割条；键盘支持：左右键 1px，Shift+左右键 10px；
  - A11y：分割条 handle 使用 `role="slider"`，提供 `aria-valuemin/max/now`；
  - 渲染：两张原图在两个叠放的 `<canvas>`，通过 `clip`/绘制宽度控制可见区域；
  - 提供“交换左右”按钮。
- 热力图：
  - 背景为棋盘格（CSS 背景或单独画布），热力图为独立 `<canvas>`；
  - 仅绘制红色通道与 alpha；导出的 PNG 为“仅热力图”，不叠加原图。

### 4.5 下载
- 导出尺寸等于输入原图尺寸（不受屏幕缩放影响）。
- 文件命名：
  - 有左图文件名：`{slug(leftname)}-heatmap-t{阈值}-{YYYYMMDD-HHmmss}.png`；
  - 无文件名：`heatmap-t{阈值}-{YYYYMMDD-HHmmss}.png`；
  - `slug()` 需移除/替换非法字符，时间戳使用本地时区。

## 5. 性能与内存策略
- ≥6MP 启用 Web Worker（仅计算）：主线程负责获取 `ImageData` 与全部绘制；Worker 返回 `diff[]/validMask[]/validCount`（以可转移对象传回，避免拷贝）。
- 内存预算（粗略）：
  - 两图像素：`2 × 4 bytes × N`（ImageData RGBA）；
  - `diff[]`：`1 byte × N`；`validMask[]`：`1 byte × N`；
  - 热力图缓冲：`4 bytes × N`（可复用同一 `ImageData`）；
  - N=16MP 时总内存峰值数百 MB，确保≥6MP 时走 Worker，避免主线程卡顿。
- 统计与绘制分离：阈值变更只需重建 alpha 与计数，避免重复解码与取像素。
- 预览缩放先用 CSS；点击“下载”按原始分辨率重算导出。

## 6. 组件与状态设计
### 6.1 轻量状态（位于 `src/App.tsx`）
```ts
export type ViewMode = 'split' | 'heatmap';
export interface LoadedImage {
  file?: File; name: string; width: number; height: number;
  bitmap: ImageBitmap; imageData: ImageData;
}
export interface DiffCache { width: number; height: number; diff: Uint8Array; validMask: Uint8Array; validCount: number; }
export interface AppState {
  left?: LoadedImage; right?: LoadedImage; threshold: number; view: ViewMode;
  cache?: DiffCache; changeRatio?: number; // 0..1
}
```

### 6.2 Worker 消息（精简）
```ts
export type Cmd = { type: 'compute'; a: ImageData; b: ImageData };
export type Rsp = { type: 'computed'; width: number; height: number; diff: Uint8Array; validMask: Uint8Array; validCount: number };
```

### 6.3 事件流
1) 用户拖入两图 → 校验尺寸/上限 → 加载为 `ImageBitmap`（尝试 EXIF 方向）。
2) 主线程将两图各绘制到隐藏 `<canvas>` 并获取 `ImageData`；若≥6MP，发送到 Worker 计算 `diff[]/validMask[]/validCount`；否则主线程直接计算。
3) 收到结果后：
   - 基于当前阈值映射并统计变化像素，更新 `changeRatio`；
   - 重绘热力图画布；`<split>` 视图随时可用。
4) 阈值滑动：不再计算 `d`，仅基于 `diff[]/validMask[]` 重映射/计数并更新热力图与指标。

## 7. 核心算法（单次遍历）
```ts
// 计算 diff[] 与 validMask[]；忽略任一张 alpha<255 的像素
export function computeDiff(a: ImageData, b: ImageData) {
  const { width, height, data: A } = a; const B = b.data;
  const N = width * height; const diff = new Uint8Array(N);
  const valid = new Uint8Array(N); let validCount = 0;
  for (let i = 0, p = 0; i < N; i++, p += 4) {
    const aA = A[p + 3], bA = B[p + 3];
    if (aA === 255 && bA === 255) {
      const d = (Math.abs(A[p] - B[p]) + Math.abs(A[p + 1] - B[p + 1]) + Math.abs(A[p + 2] - B[p + 2])) / 3;
      diff[i] = d; valid[i] = 1; validCount++;
    } else { diff[i] = 0; valid[i] = 0; }
  }
  return { width, height, diff, validMask: valid, validCount } as const;
}

// 阈值映射到热力图（纯红，alpha 线性映射）；返回变化像素数
export function applyThresholdToHeatmap(diff: Uint8Array, valid: Uint8Array, w: number, h: number, t: number, out: ImageData) {
  const D = diff, V = valid, N = w * h, pix = out.data; let changed = 0;
  const denom = 255 - t || 1; // t=255 防除零
  for (let i = 0, p = 0; i < N; i++, p += 4) {
    const isValid = V[i] === 1; const d = D[i];
    if (!isValid || d <= t) { pix[p]=255; pix[p+1]=0; pix[p+2]=0; pix[p+3]=0; continue; }
    const a = Math.round(255 * (d - t) / denom);
    pix[p]=255; pix[p+1]=0; pix[p+2]=0; pix[p+3]=a; changed++;
  }
  return changed;
}
```

备注：可预先构建 `alphaLut[d]`；阈值频繁变化时仅需重写 `out.data` 与重新统计 `changed`。

## 8. 画布与绘制
- 预览缩放：界面层使用 CSS 等比缩放 `<canvas>`，绘制与导出均使用原始分辨率画布。
- 棋盘格背景：CSS 背景或预生成小尺寸 pattern 平铺（优先 CSS）。
- 导出 PNG：使用 `canvas.toBlob()`，文件名按 4.5 约定；文件名需 `slug()` 处理非法字符。
- 交换左右：仅交换引用与展示顺序，不改变缓存与计算的正确性。

## 9. 错误处理与文案（示例）
- 尺寸不一致：`两张图片尺寸需一致：A=1920×1080，B=2048×1080`。
- 超出像素上限：`单图像素上限为 16MP 或任一边不超过 8192px`。
- 解码失败：`图片解码失败，请更换文件（建议 PNG/JPEG/WebP）`。
- 文件不足/过多：`请拖入两张图片，或选择文件`。
- 同名提示（非阻断）：`已选择同名文件，建议确认左右顺序`。
- EXIF 回退提示（非阻断）：`检测到环境不支持自动旋转，拍照素材可能存在方向差异。`

## 10. 可访问性与交互细节
- 分割条：键盘左右 1px，Shift+左右 10px；handle 使用 `role="slider"`，附 `aria-valuemin/max/now`。
- 控件：阈值滑杆提供实时 `aria-live` 更新（%）以便读屏。
- 颜色：主要依赖透明度表达强度（非色盲关键信息），变化占比为文本显示。

## 11. 示例资源
- `public/examples/{setN}/left.png` 与 `right.png`；3 组，来源自制或 CC0。
- 首页提供“加载示例”下拉，点击即载入对应资源。

## 12. 构建与开发
- Node 版本：≥ 18。
- 常用命令：
```
# 安装依赖
yarn || pnpm i || npm i
# 开发
yarn dev
# 构建
yarn build
# 预览静态产物
yarn preview
```
- ESLint/Prettier：提供基础规则与脚本，构建不阻断（开发期间可手动修复）。

## 13. 部署（GitHub Pages）
- 产物：`dist/` 纯静态文件，可离线使用。
- 指南：
  1) 项目设置 Pages 来源为 `gh-pages` 分支或 `docs/` 目录；
  2) 使用 `vite` 的 `base` 选项配置仓库子路径（如有需要）；
  3) 推送 `dist/` 到 `gh-pages` 分支（可用脚本或 Actions），无任何外部网络依赖。

## 14. 可选：替换为 Preact（减小体积）
- `npm i -D @preact/preset-vite`；在 `vite.config.ts` 中启用；
- 或使用 alias：
```ts
resolve: { alias: { react: 'preact/compat', 'react-dom': 'preact/compat' } }
```
- 验证交互与渲染一致性即可。

## 15. 验收标准（Checklist）
- [ ] 拖拽/选择两图，尺寸相同校验通过并显示尺寸；
- [ ] 尺寸不一致/超上限能明确报错（含两图尺寸）；
- [ ] 阈值默认 32；滑动实时更新两视图与变化占比；
- [ ] 分割条可拖拽与键盘微调（role=slider + aria 值）；支持“交换左右”；
- [ ] 热力图只在 `d>t` 处显现，强度随 `d` 线性映射（t=255 全透明）；
- [ ] 变化占比与忽略透明规则符合定义，`changed/validCount` 正确；有效像素数显示避免除零；
- [ ] ≥6MP 自动启用 Worker（仅计算），主线程绘制流畅；在 Chrome/Edge/Firefox/Safari 实测阈值拖动不卡顿；
- [ ] 下载得到仅热力图 PNG，尺寸等于原始尺寸，文件名包含 slug(左图名)/阈值/时间戳；
- [ ] 示例 3 组可一键加载；
- [ ] 构建产物离线可用，无外部请求。

## 16. 未来扩展建议
- 自动对齐（特征/亚像素平移）；差分指标扩充（MSE/PSNR/SSIM）。
- 多阈值分层/伪彩热力图；区域选择与统计；
- 基线管理/批量比较/CI 集成；
- PWA/桌面封装；服务端批处理与报告导出。

## 17. 许可证与合规
- 代码：MIT；
- 示例素材：CC0 或自制；在 `public/examples` 目录标注来源说明文件。

---
## 附录 A：主要实现片段（建议参考）
```ts
// src/utils/image.ts
export async function loadBitmap(file: File) {
  try {
    const bmp = await createImageBitmap(file, { imageOrientation: 'from-image' } as any);
    return { bmp, name: file.name.replace(/\.[^.]+$/, '') } as const;
  } catch {
    const bmp = await createImageBitmap(file);
    return { bmp, name: file.name.replace(/\.[^.]+$/, '') } as const;
  }
}

export function toImageData(bitmap: ImageBitmap, w = bitmap.width, h = bitmap.height) {
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d', { willReadFrequently: true })!;
  ctx.drawImage(bitmap, 0, 0, w, h);
  return ctx.getImageData(0, 0, w, h);
}
```
```ts
// src/workers/diff.worker.ts
import { computeDiff } from '../utils/math'; // 或直接粘贴第 7 节函数

type Cmd = { type: 'compute'; a: ImageData; b: ImageData };
type Rsp = { type: 'computed'; width: number; height: number; diff: Uint8Array; validMask: Uint8Array; validCount: number };

self.onmessage = (e: MessageEvent<Cmd>) => {
  const msg = e.data;
  if (msg.type === 'compute') {
    const { width, height, diff, validMask, validCount } = computeDiff(msg.a, msg.b);
    (self as any).postMessage(
      { type: 'computed', width, height, diff, validMask, validCount } as Rsp,
      [diff.buffer, validMask.buffer]
    );
  }
};
```
```ts
// src/utils/canvas.ts
export function drawHeatmap(ctx: CanvasRenderingContext2D, imageData: ImageData) {
  ctx.putImageData(imageData, 0, 0);
}
export function downloadPNG(canvas: HTMLCanvasElement, filename: string) {
  canvas.toBlob((blob) => {
    if (!blob) return;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    URL.revokeObjectURL(a.href);
  });
}
export function timestamp() {
  const d = new Date(); const pad = (n:number)=>String(n).padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}
export function slug(name: string) {
  return name.toLowerCase().replace(/[^a-z0-9._-]+/g, '-').replace(/^-+|-+$/g, '').slice(0, 80) || 'image';
}
```

## 附录 B：UI 细节（建议）
- 布局：上方 DropZone/示例选择与阈值滑杆，下方切换视图（Tabs：分割 | 热力图），右上角显示变化占比。
- 尺寸可见：在文件卡片下方显示 `宽×高`；错误提示包含两图实际尺寸。
- 滑杆数值：旁边显示当前阈值（0–255）。
- 交互回退：在高负载设备上，阈值连续拖动时可节流至每 16ms 刷新一次。
